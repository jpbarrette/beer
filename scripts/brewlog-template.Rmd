
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r cars, include=FALSE}
library(rvest)
library(xml2)
library(dplyr)
source("biab-calculator.R")

# retrieve the xml recipe
beerxml_output <- read_xml(brewlog_file)

batch_size <- xml_double(xml_find_first(beerxml_output, xpath='//BATCH_SIZE'))
grain_weight <- sum(xml_double(xml_find_all(beerxml_output, xpath='//FERMENTABLES/*/AMOUNT')))
grain_temp <- xml_double(xml_find_first(beerxml_output, xpath='//MASH/GRAIN_TEMP'))
mash_temp <- xml_double(xml_find_first(beerxml_output, xpath='//MASH/MASH_STEPS/*/STEP_TEMP'))
boil_time <- xml_double(xml_find_first(beerxml_output, xpath='//BOIL_TIME'))

# TODO fix this
timetaken <- function(mins)
{
   hrs <- mins %/% 60
   days <- hrs %/% 24
   
   ifelse (days == 1, "1 day", days)
           ifelse(days >= 1, sprintf("%d days", as.integer(days)),
                  sprintf("%.0f mins", mins))
}


recipe <- create_metric_recipe(grain_weight, grain_temp, batch_size, mash_temp, boil_time, system_variables)
```
# BIAB Calculator

Calculations taken from [BIAB Calculator](http://www.biabcalculator.com/)

TODO: Add method, style, etc.

## Recipe Parameter

* Grain Bill: `r recipe$grain_weight` Kilograms
* Grain Temp: `r recipe$grain_temp` Celsius
* Batch Size: `r recipe$batch_size` Liters
* Mash Temp: `r recipe$mash_temp` Celsius
* Boil Time: `r recipe$boil_time` Minutes
    
## System Variables

* Kettle Size: `r recipe$kettle_size` Liters
* Trub: `r recipe$trub_size` Liters
* Boiloff Rate: `r recipe$boiloff_rate` Liters/Houree
* Grain Absorption: `r recipe$grain_absorption` Liters/Kilograms of grain
    
## Recipe Output

* Total Water Needed: `r round(get_water_needed(recipe), 2)` Liters
* Strike Water Temp: `r round(get_strike_water_temp(recipe), 1)` Celsius
* Total Mash Volume: `r round(get_total_mash_volume(recipe), 2)` Liters
* Preboil Wort: `r round(get_pre_boil_wort_volume(recipe), 2)` Liters
* Postboil Wort: `r round(get_post_boil_wort_volume(recipe), 2)` Liters
* Into Fermenter: `r round(get_fermenter_volume(recipe), 2)` Liters
        
```{r kable, echo=FALSE}

library(xml2)
library(knitr)

data <- XML::xmlParse(brewlog_file)
fermentables <- XML::xmlToDataFrame(nodes = XML::getNodeSet(data, "//FERMENTABLES/*"), stringsAsFactors = FALSE, colClasses=c("character", "integer", "character", "double", "double", "double", "character", "character")) %>% mutate(Name = paste(ORIGIN, " - " , NAME), Amount = AMOUNT, Yield = YIELD, Lovibond = COLOR, "Bill %" = sprintf("%.1f", Amount/sum(Amount) * 100)) %>% select(Name, Amount, Yield, Lovibond, "Bill %")

hops <- XML::xmlToDataFrame(nodes = XML::getNodeSet(data, "//HOPS/*"), stringsAsFactors = FALSE, colClasses=c("character", "integer", "double", "double", "character", "character", "integer", "character", "double", "double"))
#hops$TIME <- as.difftime(hops$TIME, units="mins") 

#TODO Add IBU
hops <- mutate(hops, Amount=sprintf("%.fg", AMOUNT*1000), AA=ALPHA, Variety=NAME, Type=FORM, Use = USE, Time = timetaken(TIME)) %>% 
  select(Amount, Variety, Type, AA, Use, Time)



```

# Fermentables 

```{r kable-fermentables, echo=FALSE}

kable(fermentables)

```

# Hops 

```{r kable-hops, echo=FALSE}

kable(hops)

```